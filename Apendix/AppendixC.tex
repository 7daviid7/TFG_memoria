\chapter{Manual del Desenvolupador}
\label{appendix:manual_desenvolupador}

Aquest annex serveix com a guia tècnica detallada per a configurar l'entorn de desenvolupament local, permetent a futurs col·laboradors executar, depurar i desplegar el projecte NUMEN.

\section{Preparació de l'Entorn}

Abans de clonar el repositori, cal assegurar-se que la màquina de desenvolupament compleix amb els requisits previs.

\subsection{Instal·lació de Flutter SDK}
El projecte es basa en el framework Flutter. Cal descarregar la versió estable més recent des del lloc oficial (\url{https://flutter.dev}) i afegir el binari al \texttt{PATH} del sistema.

\begin{lstlisting}[language=bash, caption={Verificació de la instal·lació de Flutter}]
flutter doctor
\end{lstlisting}

\subsection{Node.js i NPM}
Les eines de línia de comandes de Firebase (\texttt{firebase-tools}) depenen de Node.js. Cal instal·lar la versió LTS de Node.js, que inclou el gestor de paquets NPM.

\begin{lstlisting}[language=bash, caption={Instal·lació de Firebase CLI via NPM}]
npm install -g firebase-tools
firebase login
\end{lstlisting}

\subsection{Visual Studio Code i Extensions}
L'entorn recomanat (IDE) és Visual Studio Code (VS Code). Per a una experiència òptima amb Flutter, es recomana instal·lar les extensions oficials:
\begin{itemize}
    \item \textbf{Flutter} (Dart-Code.flutter)
    \item \textbf{Dart} (Dart-Code.dart-code)
\end{itemize}

\section{Configuració Inicial del Projecte}

Un cop clonat el repositori, cal instal·lar les dependències i configurar els serveis del núvol.

\subsection{Instal·lació de Dependències}
Des de l'arrel del projecte, executar:
\begin{lstlisting}[language=bash]
flutter pub get
\end{lstlisting}

\subsection{Configuració de Firebase (FlutterFire)}
Per vincular el projecte local amb el projecte de Firebase al núvol, s'utilitza l'eina \texttt{flutterfire\_cli}. Si és el primer cop que es configura en una màquina nova:

\begin{lstlisting}[language=bash, caption={Activació i configuració de FlutterFire}]
dart pub global activate flutterfire_cli
flutterfire configure
\end{lstlisting}

Aquesta comanda guiarà a l'usuari per seleccionar el projecte de Firebase existent i generarà automàticament el fitxer \texttt{lib/firebase\_options.dart} amb les credencials actualitzades per a cada plataforma (Web, Android, iOS, Windows).

\section{Depuració i Execució}

Per facilitar la depuració en VS Code, el projecte inclou una configuració de llançament predefinida. No obstant això, donat que es requereix la injecció de la clau d'API, es recomana configurar el fitxer \texttt{.vscode/launch.json} o utilitzar arguments.

\subsection{Configuració de launch.json}
Es recomana configurar el fitxer \texttt{.vscode/launch.json} per utilitzar el paràmetre \texttt{--dart-define-from-file=.env}. Això permet que VS Code llegeixi automàticament totes les variables del fitxer d'entorn sense haver de llistar-les manualment.

\begin{lstlisting}[caption={Exemple de configuració launch.json optimitzada}]
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "numerologia_flutter (Web)",
            "request": "launch",
            "type": "dart",
            "args": [ "-d", "chrome" ],
            "toolArgs": [
                "--dart-define-from-file=.env"
            ]
        }
    ]
}
\end{lstlisting}

Amb aquesta configuració, el desenvolupador pot senzillament prémer la tecla \textbf{F5} (o fer clic a "Start Debugging") per compilar i executar l'aplicació amb totes les claus configurades correctament, agilitzant significativament el cicle de desenvolupament.

\section{Automatització del Desplegament}

Tal com s'ha descrit al Capítol \ref{chapter:implantacio_resultats}, el desplegament a producció està automatitzat mitjançant l'script \texttt{tools/deploy\_prod.bat}. Aquest script requereix un fitxer \texttt{.env} a l'arrel del projecte amb la clau d'API vàlida.

\begin{lstlisting}[language=bash, caption={Execució del desplegament}]
./tools/deploy_prod.bat
\end{lstlisting}

Aquest procés netejarà l'entorn, compilarà l'aplicació en mode \emph{release} (injectant la clau des del \texttt{.env}) i la pujarà a Firebase Hosting.


\section{Guia d'Instal·lació i Codi PWA}
\label{sec:pwa_guide}

L'aplicació NUMEN és una \textit{Progressive Web App} (PWA), el que permet instal·lar-la com si fos una aplicació nativa sense passar per les botigues d'aplicacions (App Store / Play Store). El comportament d'instal·lació varia segons el dispositiu.

\subsection{Escriptori (Windows / macOS)}
En navegadors basats en Chromium (Google Chrome, Microsoft Edge, Brave), el navegador detecta automàticament que el lloc web és una PWA.
L'usuari veurà una icona d'instal·lació a la part dreta de la barra de direccions (veure Figura \ref{fig:pwa_desktop}).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth, frame]{Imatges/pwa_desktop_install.png}
    \caption{Icona d'instal·lació PWA a la barra de direccions (Google Chrome).}
    \label{fig:pwa_desktop}
\end{figure}

També és possible instal·lar l'aplicació des del menú d'opcions del navegador (els tres punts verticals $\vdots$) seleccionant ``Instal·lar NUMEN'' o ``Afegir a la pantalla d'inici''.

\subsection{Dispositius iOS (iPhone / iPad)}
A diferència d'Android o Windows, l'ecosistema d'Apple (iOS) no mostra cap avís automàtic per instal·lar aplicacions web. Això representa una barrera d'entrada per a l'usuari final.

Per solucionar-ho, s'ha implementat un component visual personalitzat (\texttt{pwa\_install\_prompt.dart}) que detecta si l'usuari navega des d'un iPhone (mitjançant \textit{User Agent}) i si l'app no està encara en mode pantalla completa (\textit{standalone}).
Si es compleixen aquestes condicions, es mostra un quadre de diàleg explicatiu amb els passos manuals a seguir:

\begin{enumerate}
    \item Prémer el botó \textbf{Compartir} de Safari (icona quadrada amb fletxa cap amunt).
    \item Seleccionar l'opció \textbf{``Afegir a l'inici''} (\textit{Add to Home Screen}).
\end{enumerate}

\subsection{Codi Font: Detecció i Prompt iOS}
A continuació es mostra el codi Dart encarregat de la detecció del navegador i la renderització del prompt d'ajuda per a usuaris d'iOS.

\begin{lstlisting}[language=Dart, caption={Lògica de detecció i prompt PWA per a iOS (pwa\_install\_prompt.dart)}, label={lst:pwa_code}]
// 1. Check if running on Web
if (!kIsWeb) return;

// 2. Check if platform is iOS (User Agent check)
// (Inclou comprovacio per iPadOS que demana desktop site per defecte)
final userAgent = js.context['navigator']['userAgent'].toString().toLowerCase();
final isIos = userAgent.contains('iphone') || 
              userAgent.contains('ipad') || 
              userAgent.contains('ipod');

// ... (logica addicional per iPadOS) ...

// 3. Check if ALREADY in Standalone mode (Installed)
bool isStandalone = false;
try {
  final mediaQuery = js.context.callMethod('matchMedia', ['(display-mode: standalone)']);
  if (mediaQuery != null && mediaQuery['matches'] == true) {
    isStandalone = true;
  }
} catch (_) {}

if (isStandalone) return;

// Mostra el prompt visual
setState(() {
  _isVisible = true;
});
\end{lstlisting}
